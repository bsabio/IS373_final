---
title: Review Submissions
layout: base.njk
permalink: "/review/index.html"
---

<h1>Review Submissions</h1>

<div id="list">
  <p>Loading submissions…</p>
</div>

<template id="itemTpl">
  <article class="submission" data-id="">
    <h2 class="name"></h2>
    <p><strong>Email:</strong> <a class="email" href="mailto:"></a></p>
    <p><strong>Style:</strong> <span class="style"></span></p>
    <p><strong>Description:</strong> <span class="description"></span></p>
    <p><a class="url" target="_blank" rel="noopener">Visit student URL</a></p>
    <div class="screenshotWrap"><img class="screenshot" alt="Submission screenshot"/></div>
    <div class="actions">
      <button class="approve">Approve</button>
      <button class="reject">Reject</button>
    </div>
    <hr/>
  </article>
</template>

<div id="msg" role="status" aria-live="polite"></div>

<script>
const API_ROOT = (typeof window.API_ROOT !== 'undefined') ? window.API_ROOT : ''
const list = document.getElementById('list')
const tpl = document.getElementById('itemTpl')
const msg = document.getElementById('msg')

function showMsg(text, isError=false){
  msg.textContent = text
  msg.style.color = isError ? 'crimson' : 'green'
}

async function loadSubmissions(){
  try{
    const r = await fetch(API_ROOT + '/api/reviews')
    if(!r.ok) throw new Error('Failed to load submissions')
    const data = await r.json()
    renderList(data.submissions || [])
  }catch(err){
    console.error(err)
    list.innerHTML = '<p>Error loading submissions.</p>'
  }
}

function renderList(items){
  if(!items.length){
    list.innerHTML = '<p>No pending submissions.</p>'
    return
  }
  list.innerHTML = ''
  items.forEach(it => {
    const node = tpl.content.cloneNode(true)
    const article = node.querySelector('article')
    article.dataset.id = it._id
    article.querySelector('.name').textContent = it.name
    const emailLink = article.querySelector('.email')
    emailLink.href = 'mailto:' + it.email
    emailLink.textContent = it.email
    article.querySelector('.style').textContent = it.style?.title || '—'
    article.querySelector('.description').textContent = it.description
    const urlLink = article.querySelector('.url')
    urlLink.href = it.url
    urlLink.textContent = it.url
    const img = article.querySelector('.screenshot')
    img.src = it.screenshot?.asset?.url || ''
    img.alt = `Screenshot for submission by ${it.name}`

    const approveBtn = article.querySelector('.approve')
    const rejectBtn = article.querySelector('.reject')

    approveBtn.addEventListener('click', () => handleAction(it._id, 'approve', article))
    rejectBtn.addEventListener('click', () => handleAction(it._id, 'reject', article))

    list.appendChild(node)
  })
}

async function handleAction(id, action, articleEl){
  const endpoint = action === 'approve' ? '/api/approve' : '/api/reject'
  showMsg(`${action}ing...`)
  try{
    const r = await fetch(API_ROOT + endpoint, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ id })
    })
    const json = await r.json()
    if(!r.ok || json.error) throw new Error(json.error || 'Action failed')
    showMsg(`${action.charAt(0).toUpperCase() + action.slice(1)}ed successfully`)
    // remove the article from the list
    articleEl.remove()
    // If list empty, show placeholder
    if(!list.querySelector('article')) list.innerHTML = '<p>No pending submissions.</p>'
  }catch(err){
    console.error(err)
    showMsg('Error: ' + (err.message || 'Action failed'), true)
  }
}

loadSubmissions()
</script>
