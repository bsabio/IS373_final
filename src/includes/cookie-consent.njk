<!-- Cookie Consent Banner -->
<div id="cookie-consent-banner" class="cookie-banner" style="display: none;">
  <div class="cookie-banner-content">
    <div class="cookie-banner-text">
      <h3>üç™ Cookie Preferences</h3>
      <p>We use cookies to improve your experience. We only activate analytics cookies with your consent. <a href="{{ '/pages/privacy/' | url }}">Learn more in our Privacy Policy</a>.</p>
    </div>
    <div class="cookie-banner-buttons">
      <button id="cookie-accept-all" class="btn btn-primary">Accept All</button>
      <button id="cookie-reject-all" class="btn btn-secondary">Reject All</button>
      <button id="cookie-customize" class="btn btn-secondary">Customize</button>
    </div>
  </div>
</div>

<!-- Cookie Customization Modal -->
<div id="cookie-modal" class="cookie-modal" style="display: none;">
  <div class="cookie-modal-content">
    <h2>Cookie Preferences</h2>
    <p>Choose which cookies you want to allow. Essential cookies are always active.</p>
    
    <div class="cookie-option">
      <label>
        <input type="checkbox" id="cookie-essential" checked disabled>
        <strong>Essential Cookies</strong>
        <span class="required">(Required)</span>
      </label>
      <p>Necessary for the website to function. These include cookie consent preferences.</p>
    </div>
    
    <div class="cookie-option">
      <label>
        <input type="checkbox" id="cookie-analytics">
        <strong>Analytics Cookies</strong>
        <span class="optional">(Optional)</span>
      </label>
      <p>Help us understand how visitors use our site through privacy-friendly Plausible Analytics. No personal data is collected.</p>
    </div>
    
    <div class="cookie-modal-buttons">
      <button id="cookie-save-preferences" class="btn btn-primary">Save Preferences</button>
      <button id="cookie-modal-close" class="btn btn-secondary">Cancel</button>
    </div>
  </div>
</div>

<style>
.cookie-banner {
  position: fixed;
  bottom: 0;
  left: 0;
  right: 0;
  background: #1f2937;
  color: white;
  padding: 1.5rem;
  box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.1);
  z-index: 9999;
  animation: slideUp 0.3s ease-out;
}

@keyframes slideUp {
  from {
    transform: translateY(100%);
  }
  to {
    transform: translateY(0);
  }
}

.cookie-banner-content {
  max-width: 1200px;
  margin: 0 auto;
  display: flex;
  flex-wrap: wrap;
  align-items: center;
  justify-content: space-between;
  gap: 1rem;
}

.cookie-banner-text {
  flex: 1;
  min-width: 300px;
}

.cookie-banner-text h3 {
  margin: 0 0 0.5rem 0;
  font-size: 1.25rem;
}

.cookie-banner-text p {
  margin: 0;
  font-size: 0.95rem;
  line-height: 1.5;
}

.cookie-banner-text a {
  color: #60a5fa;
  text-decoration: underline;
}

.cookie-banner-buttons {
  display: flex;
  gap: 0.75rem;
  flex-wrap: wrap;
}

.cookie-modal {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(0, 0, 0, 0.75);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 10000;
  padding: 1rem;
}

.cookie-modal-content {
  background: white;
  padding: 2rem;
  border-radius: 8px;
  max-width: 500px;
  width: 100%;
  max-height: 90vh;
  overflow-y: auto;
}

.cookie-modal-content h2 {
  margin-top: 0;
  color: #1f2937;
}

.cookie-option {
  margin: 1.5rem 0;
  padding: 1rem;
  background: #f9fafb;
  border-radius: 4px;
}

.cookie-option label {
  display: flex;
  align-items: center;
  gap: 0.5rem;
  cursor: pointer;
  font-size: 1rem;
}

.cookie-option input[type="checkbox"] {
  width: 18px;
  height: 18px;
  cursor: pointer;
}

.cookie-option input[type="checkbox"]:disabled {
  cursor: not-allowed;
}

.cookie-option .required {
  color: #dc2626;
  font-size: 0.85rem;
}

.cookie-option .optional {
  color: #059669;
  font-size: 0.85rem;
}

.cookie-option p {
  margin: 0.5rem 0 0 0;
  font-size: 0.9rem;
  color: #6b7280;
}

.cookie-modal-buttons {
  display: flex;
  gap: 0.75rem;
  margin-top: 1.5rem;
  flex-wrap: wrap;
}

.btn {
  padding: 0.75rem 1.5rem;
  border: none;
  border-radius: 4px;
  font-size: 0.95rem;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.2s;
}

.btn-primary {
  background: #2563eb;
  color: white;
}

.btn-primary:hover {
  background: #1e40af;
}

.btn-secondary {
  background: #6b7280;
  color: white;
}

.btn-secondary:hover {
  background: #4b5563;
}

@media (max-width: 768px) {
  .cookie-banner-content {
    flex-direction: column;
    align-items: stretch;
  }
  
  .cookie-banner-buttons {
    justify-content: stretch;
  }
  
  .cookie-banner-buttons .btn {
    flex: 1;
  }
  
  .cookie-modal-content {
    padding: 1.5rem;
  }
}
</style>

<script>
(function() {
  'use strict';
  
  const CONSENT_KEY = 'mywebclass_cookie_consent';
  const CONSENT_TIMESTAMP_KEY = 'mywebclass_consent_timestamp';
  const CONSENT_EXPIRY_DAYS = 365;
  
  // Check if consent has expired (older than 365 days)
  function isConsentExpired() {
    const timestamp = localStorage.getItem(CONSENT_TIMESTAMP_KEY);
    if (!timestamp) return true;
    
    const consentDate = new Date(parseInt(timestamp));
    const now = new Date();
    const daysDiff = (now - consentDate) / (1000 * 60 * 60 * 24);
    
    return daysDiff > CONSENT_EXPIRY_DAYS;
  }
  
  // Get current consent status
  function getConsent() {
    if (isConsentExpired()) {
      // Clear expired consent
      localStorage.removeItem(CONSENT_KEY);
      localStorage.removeItem(CONSENT_TIMESTAMP_KEY);
      return null;
    }
    
    const consent = localStorage.getItem(CONSENT_KEY);
    return consent ? JSON.parse(consent) : null;
  }
  
  // Save consent preferences
  function saveConsent(preferences) {
    localStorage.setItem(CONSENT_KEY, JSON.stringify(preferences));
    localStorage.setItem(CONSENT_TIMESTAMP_KEY, Date.now().toString());
  }
  
  // Load analytics if consented
  function loadAnalytics() {
    const consent = getConsent();
    if (consent && consent.analytics === true) {
      console.log('‚úÖ Analytics consent granted - Loading Plausible');
      // This is where Plausible script will be loaded
      const script = document.createElement('script');
      script.defer = true;
      script.setAttribute('data-domain', 'bsabio.github.io');
      script.src = 'https://plausible.io/js/script.js';
      document.head.appendChild(script);
    } else {
      console.log('‚ùå Analytics consent not granted - Plausible NOT loaded');
    }
  }
  
  // Show cookie banner
  function showBanner() {
    const banner = document.getElementById('cookie-consent-banner');
    if (banner) {
      banner.style.display = 'block';
    }
  }
  
  // Hide cookie banner
  function hideBanner() {
    const banner = document.getElementById('cookie-consent-banner');
    if (banner) {
      banner.style.display = 'none';
    }
  }
  
  // Show cookie modal
  function showModal() {
    const modal = document.getElementById('cookie-modal');
    const consent = getConsent();
    
    // Pre-fill current preferences if they exist
    if (consent) {
      document.getElementById('cookie-analytics').checked = consent.analytics || false;
    }
    
    if (modal) {
      modal.style.display = 'flex';
    }
  }
  
  // Hide cookie modal
  function hideModal() {
    const modal = document.getElementById('cookie-modal');
    if (modal) {
      modal.style.display = 'none';
    }
  }
  
  // Accept all cookies
  function acceptAll() {
    const preferences = {
      essential: true,
      analytics: true
    };
    saveConsent(preferences);
    hideBanner();
    loadAnalytics();
    console.log('‚úÖ All cookies accepted');
  }
  
  // Reject all optional cookies
  function rejectAll() {
    const preferences = {
      essential: true,
      analytics: false
    };
    saveConsent(preferences);
    hideBanner();
    console.log('‚ùå Optional cookies rejected');
  }
  
  // Save custom preferences
  function savePreferences() {
    const analyticsChecked = document.getElementById('cookie-analytics').checked;
    const preferences = {
      essential: true,
      analytics: analyticsChecked
    };
    saveConsent(preferences);
    hideModal();
    hideBanner();
    
    if (analyticsChecked) {
      loadAnalytics();
    }
    
    console.log('üíæ Custom preferences saved:', preferences);
  }
  
  // Initialize on page load
  document.addEventListener('DOMContentLoaded', function() {
    const consent = getConsent();
    
    if (!consent) {
      // No consent exists - show banner
      console.log('üç™ No cookie consent found - Showing banner');
      showBanner();
    } else {
      // Consent exists - load analytics if permitted
      console.log('‚úÖ Cookie consent found:', consent);
      loadAnalytics();
    }
    
    // Attach event listeners
    const acceptButton = document.getElementById('cookie-accept-all');
    const rejectButton = document.getElementById('cookie-reject-all');
    const customizeButton = document.getElementById('cookie-customize');
    const saveButton = document.getElementById('cookie-save-preferences');
    const modalCloseButton = document.getElementById('cookie-modal-close');
    
    if (acceptButton) {
      acceptButton.addEventListener('click', acceptAll);
    }
    
    if (rejectButton) {
      rejectButton.addEventListener('click', rejectAll);
    }
    
    if (customizeButton) {
      customizeButton.addEventListener('click', function() {
        showModal();
      });
    }
    
    if (saveButton) {
      saveButton.addEventListener('click', savePreferences);
    }
    
    if (modalCloseButton) {
      modalCloseButton.addEventListener('click', hideModal);
    }
    
    // Close modal on outside click
    const modal = document.getElementById('cookie-modal');
    if (modal) {
      modal.addEventListener('click', function(e) {
        if (e.target === modal) {
          hideModal();
        }
      });
    }
  });
  
  // Global function to allow users to change preferences later
  window.openCookiePreferences = function() {
    showModal();
  };
})();
</script>
